<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>The Secret Sauce Behind Better Product Recommendation: MMR Explained | fahrizain</title><meta name=keywords content="reranking,RAG,product recommendation,recsys"><meta name=description content="How MMR Enhances Diversity and User Experience in Product Suggestions."><meta name=author content="Affandy Fahrizain"><link rel=canonical href=https://fhrzn.github.io/posts/the-secret-sauce-behind-better-product-recommendation-mmr-explained/><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=https://fhrzn.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://fhrzn.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://fhrzn.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://fhrzn.github.io/apple-touch-icon.png><link rel=mask-icon href=https://fhrzn.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://fhrzn.github.io/posts/the-secret-sauce-behind-better-product-recommendation-mmr-explained/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css integrity=sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ crossorigin=anonymous referrerpolicy=no-referrer><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js integrity=sha384-VQ8d8WVFw0yHhCk5E8I86oOhv48xLpnDZx5T9GogA/Y84DcCKWXDmSDfn13bzFZY crossorigin=anonymous referrerpolicy=no-referrer type=text/javascript></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous referrerpolicy=no-referrer type=text/javascript></script><script type=text/javascript>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1}]})})</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-27DEESLMGL"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-27DEESLMGL")</script><meta property="og:url" content="https://fhrzn.github.io/posts/the-secret-sauce-behind-better-product-recommendation-mmr-explained/"><meta property="og:site_name" content="fahrizain"><meta property="og:title" content="The Secret Sauce Behind Better Product Recommendation: MMR Explained"><meta property="og:description" content="How MMR Enhances Diversity and User Experience in Product Suggestions."><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-05-25T18:37:32+07:00"><meta property="article:modified_time" content="2025-05-25T18:37:32+07:00"><meta property="article:tag" content="Reranking"><meta property="article:tag" content="RAG"><meta property="article:tag" content="Product Recommendation"><meta property="article:tag" content="Recsys"><meta property="og:image" content="https://fhrzn.github.io/posts/the-secret-sauce-behind-better-product-recommendation-mmr-explained/%3Cimage%20path/url%3E"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://fhrzn.github.io/posts/the-secret-sauce-behind-better-product-recommendation-mmr-explained/%3Cimage%20path/url%3E"><meta name=twitter:title content="The Secret Sauce Behind Better Product Recommendation: MMR Explained"><meta name=twitter:description content="How MMR Enhances Diversity and User Experience in Product Suggestions."><meta name=twitter:site content="@fhrzn_"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://fhrzn.github.io/posts/"},{"@type":"ListItem","position":2,"name":"The Secret Sauce Behind Better Product Recommendation: MMR Explained","item":"https://fhrzn.github.io/posts/the-secret-sauce-behind-better-product-recommendation-mmr-explained/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"The Secret Sauce Behind Better Product Recommendation: MMR Explained","name":"The Secret Sauce Behind Better Product Recommendation: MMR Explained","description":"How MMR Enhances Diversity and User Experience in Product Suggestions.","keywords":["reranking","RAG","product recommendation","recsys"],"articleBody":"On my journey building a RAG-based product recommendation system, I learned one important lesson: adding diversity aspect in search space is beneficial for end users.\nAt the end, I stumbled upon the Maximal Marginal Relevance (MMR) algorithm which is simple but enough to improve our user satisfaction.\nSo, in this article I‚Äôll explain how MMR works, its benefits, and how it can be integrated into a RAG system for product recommendation.\nRAG for Product Recommendation If you‚Äôve been working on RAG before, you must be familiar enough with the similarity-based retrieval process.\nHowever, if you are new to this field, you may want to read our previous article to grasp the concept of RAG and Vector Database.\nNothing fancy here honestly, no agentic, no buzzwords, just basic RAG architecture.\nInitially, this simple setup is working fine. We got question from the user, transform it into a vector embedding, perform similarity search towards data in vector db, obtain the result, pass it to LLM to generate natural answers.\nOh, there is an additional rule. The system must give only one recommendation at a time. Since we passed top-5 products, the LLM then need to decide which one is most related to user query, preferences, and previous conversation.\nBut let‚Äôs focus only on the retrieval part in this article.\nNow, given our simple approach, our team finds the retrieval feels like to have its own ‚Äúpreferences‚Äù on recommending products. Or we can formally say it slightly ‚Äúbiased‚Äù towards specific products.\nTake a look at the examples below:\nAt a glance, everything seems fine.\nBut if we take a closer look, among 5 retrieved products, 3-4 out of 5 are having exactly same type just different colors.\nEven we tried different queries, most of the time the retrieval system will pick very close product to each other.\nUnfortunately, this case didn‚Äôt pass User Acceptance Test (UAT) due to lack of product diversity ‚Äì or in their term ‚Äúsystem preference‚Äù.\nMaximum Marginal Relevance (MMR) MMR is a post-processing technique that helps to remove redundant documents by penalize its similarity score.\nIn our case, we need to retrieve relevant products which also diverse each other, which is where MMR is suited.\nHere‚Äôs the MMR formula:\n$$ [ \\text{MMR}(d_i) = \\lambda \\cdot \\text{Relevance}(d_i, q) - (1 - \\lambda) \\cdot \\max_{d_j \\in S} \\text{Similarity}(d_i, d_j) ] $$\nWhere:\n$\\lambda:$ Balancing parameter. To controls the trade-off (relevance ‚Äì diverse)\n$\\text{Relevance}:$ The relevance score of retrieved document $d_i$ w.r.t query $q$\n$\\max_{d_j \\in S} \\text{Similarity}(d_i, d_j): $ maximum similarity between the candidate document $d_i$ and any of the already selected documents $d_j$ in set $S$\nWhy is this work? Remember that the way RAG and Vector DB work is by comparing similarity between document and query embeddings.\nIn most setting, cosine similarity will be used as scoring method ‚Äì which will return the most similar documents to our query.\nIn the example above, among the top-5 products 3 of them is very close to the query points. This will introduces the ‚Äúsystem preference‚Äù as we define earlier.\nHow MMR helps? Remember that we have $\\lambda$ parameter that is responsible to control the trade-off between relevance and diversity.\nThe bigger $\\lambda$ is, the more similar products will be selected. And the smaller it is, the more diverse products will be.\nGiven the same query, we applied MMR algorithm with $\\lambda = 0.3$ (more diverse). The final top-5 products as can be seen are quite far each other in vector spaces.\nAnd it can be validated by checking the MMR-applied retrieval result below:\nIntegrate MMR to our RAG System Since MMR is a post-processing method, our RAG architecture will have an additional step before the products are sent to the LLM.\nüí° I‚Äôve previously ingest the product data which you can find it here.\nAdditionally, if you want to jump directly to the code you can find it here.\nInstall Dependencies pip install openai qdrant-client pillow matplotlib scikit-learn numpy Imports and Client Initialization from openai import OpenAI import polars as pl import uuid import httpx import asyncio from qdrant_client import QdrantClient, models import matplotlib.pyplot as plt from PIL import Image from sklearn.manifold import TSNE import numpy as np # CONFIG OPENAI_API_KEY = \"\" OPENAI_EMBEDDING_MODEL = \"text-embedding-3-small\" QDRANT_HOST = \"localhost\" QDRANT_PORT = 6333 QDRANT_COLLECTION_NAME = \"adidas_products\" CHROMADB_HOST = \"localhost\" CHROMADB_PORT = 3456 CHROMADB_COLLECTION_NAME = \"adidas_products\" # INIT oai_client = OpenAI(api_key=OPENAI_API_KEY) qdrant_client = QdrantClient(host=QDRANT_HOST, port=QDRANT_PORT) Retrieve Relevant Products query = \"Hey, I need fab shoes!\" query_embeds = oai_client.embeddings.create( input=query, model=OPENAI_EMBEDDING_MODEL) res = qdrant_client.query_points( collection_name=QDRANT_COLLECTION_NAME, query=query_embeds.data[0].embedding, with_vectors=True, limit=100, ) First, we fetch top-100 relevant products. Then, we will apply MMR and reduce the result into only 5 products.\nDefine MMR Reranking Function from sklearn.metrics.pairwise import cosine_similarity from typing import List import numpy as np def maximal_marginal_relevance( query_embedding: np.ndarray, embedding_list: list, lambda_mult: float = 0.5, k: int = 4, ) -\u003e List[int]: \"\"\"Calculate maximal marginal relevance. Usage example: ```python mmr_selected = maximal_marginal_relevance( query_embedding=np.array(query_embed, dtype=np.float32), embedding_list=ret_docs[\"embeddings\"][0], lambda_mult=0.4, k=10 ) print(mmr_selected) # Output \u003e\u003e\u003e [0, 9, 6, 12, 1, 17, 7, 2, 5, 19] ``` \"\"\" if min(k, len(embedding_list)) \u003c= 0: return [] if isinstance(query_embedding, list): query_embedding = np.array(query_embedding) if query_embedding.ndim == 1: query_embedding = np.expand_dims(query_embedding, axis=0) similarity_to_query = cosine_similarity(query_embedding, embedding_list)[0] most_similar = int(np.argmax(similarity_to_query)) idxs = [most_similar] selected = np.array([embedding_list[most_similar]]) while len(idxs) \u003c min(k, len(embedding_list)): best_score = -np.inf idx_to_add = -1 similarity_to_selected = cosine_similarity(embedding_list, selected) for i, query_score in enumerate(similarity_to_query): if i in idxs: continue redundant_score = max(similarity_to_selected[i]) equation_score = ( lambda_mult * query_score - (1 - lambda_mult) * redundant_score ) if equation_score \u003e best_score: best_score = equation_score idx_to_add = i idxs.append(idx_to_add) selected = np.append(selected, [embedding_list[idx_to_add]], axis=0) return idxs Apply MMR Reranking MMR_LAMBDA_MULT = 0.3 # prioritize diversity MMR_K = 5 # number of results to return # collect top-100 embeddings top_100_embeddings = [item.vector for item in res.points] # re-rank using MMR then take top-5 result top_5_mmr_indices = maximal_marginal_relevance(emb.embedding, top_100_embeddings, MMR_LAMBDA_MULT, MMR_K) top_5_mmr = [res.points[i] for i in top_5_mmr_indices] top_5_mmr_payload = [item.payload[\"metadata\"] for item in top_5_mmr] Visualize Products def visualize_product_rows(query, payload): fig, ax = plt.subplots(1, len(payload), figsize=(15, 8)) for i, product in enumerate(payload): ax[i].imshow(Image.open(product[\"productImage\"])) ax[i].set_title(f\"{product['productName']}\\n{product['productCategory']}\") ax[i].set_axis_off() fig.suptitle(f\"Query: {query}\", fontsize=16) plt.tight_layout(rect=[0, 0, 1, 1.35]) plt.show() visualize_product_rows(q, top_5_mmr_payload) And here is the result of our MMR reranked products. Conclusion By incorporating Maximal Marginal Relevance (MMR) into our RAG-based product recommendation system, we were able to tune the diversity of retrieved products, eliminating so-called ‚Äúsystem preference‚Äù from end user perspective. Ultimately, MMR enable our system to retrieve relevant and diverse products.\nKey Takeaways MMR Algorithm, helps to remove redundant recommendations by evaluating relevance and maximizing diversity among selected products. Parameter Tuning, adjust the $\\lambda$ parameter allows for fine control over the trade-off between relevance and diversity, enabling a tailored user experience. Diversity Enhances Satisfaction, though may be different for some users, in our case, a varied selection of products leads to a better user experience and higher engagement rates. Let‚Äôs get Connected üôå If you have any inquiries, comments, suggestions, or critics please don‚Äôt hesitate to reach me out:\nMail: affahrizain@gmail.com LinkedIn: https://www.linkedin.com/in/fahrizainn/ GitHub: https://github.com/fhrzn ","wordCount":"1165","inLanguage":"en","image":"https://fhrzn.github.io/posts/the-secret-sauce-behind-better-product-recommendation-mmr-explained/%3Cimage%20path/url%3E","datePublished":"2025-05-25T18:37:32+07:00","dateModified":"2025-05-25T18:37:32+07:00","author":{"@type":"Person","name":"Affandy Fahrizain"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://fhrzn.github.io/posts/the-secret-sauce-behind-better-product-recommendation-mmr-explained/"},"publisher":{"@type":"Organization","name":"fahrizain","logo":{"@type":"ImageObject","url":"https://fhrzn.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://fhrzn.github.io/ accesskey=h title="fahrizain (Alt + H)"><img src=https://fhrzn.github.io/favicon-32x32.png alt aria-label=logo height=30>fahrizain</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://fhrzn.github.io/ title=Posts><span>Posts</span></a></li><li><a href=https://fhrzn.github.io/profile/ title=Profile><span>Profile</span></a></li><li><a href=https://www.linkedin.com/in/fahrizainn/ title=LinkedIn><span>LinkedIn</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">The Secret Sauce Behind Better Product Recommendation: MMR Explained</h1><div class=post-description>How MMR Enhances Diversity and User Experience in Product Suggestions.</div><div class=post-meta><span title='2025-05-25 18:37:32 +0700 WIB'>May 25, 2025</span>&nbsp;¬∑&nbsp;6 min&nbsp;¬∑&nbsp;1165 words&nbsp;¬∑&nbsp;Affandy Fahrizain</div></header><figure class=entry-cover><img loading=eager src=https://fhrzn.github.io/%3Cimage%20path/url%3E alt><figcaption><text></figcaption></figure><div class=post-content><p>On my journey building a RAG-based product recommendation system, I learned one important lesson: adding diversity aspect in search space is beneficial for end users.</p><p>At the end, I stumbled upon the <strong>Maximal Marginal Relevance (MMR)</strong> algorithm which is simple but enough to improve our user satisfaction.</p><p>So, in this article I&rsquo;ll explain how MMR works, its benefits, and how it can be integrated into a RAG system for product recommendation.</p><h2 id=rag-for-product-recommendation>RAG for Product Recommendation<a hidden class=anchor aria-hidden=true href=#rag-for-product-recommendation>#</a></h2><p>If you&rsquo;ve been working on RAG before, you must be familiar enough with the similarity-based retrieval process.</p><p>However, if you are new to this field, you may want to read our previous article to grasp <a href=https://fhrzn.github.io/posts/building-conversational-ai-chat-with-your-data/#vector-database>the concept of RAG and Vector Database</a>.</p><p>Nothing fancy here honestly, no agentic, no buzzwords, just basic RAG architecture.</p><p><img alt="RAG architecture" loading=lazy src=/posts/the-secret-sauce-behind-better-product-recommendation-mmr-explained/images/rag-product-recom-arch.png></p><p>Initially, this simple setup is working fine. We got question from the user, transform it into a vector embedding, perform similarity search towards data in vector db, obtain the result, pass it to LLM to generate natural answers.</p><p>Oh, there is an additional rule. The system must give only one recommendation at a time. Since we passed top-5 products, the LLM then need to decide which one is most related to user query, preferences, and previous conversation.</p><p>But let&rsquo;s focus only on the retrieval part in this article.</p><p>Now, given our simple approach, our team finds the retrieval feels like to have its own <em>&ldquo;preferences&rdquo;</em> on recommending products. Or we can formally say it slightly <em>&ldquo;biased&rdquo;</em> towards specific products.</p><p>Take a look at the examples below:</p><p><img alt="Naive Top-5 Product Retrieval #1" loading=lazy src=/posts/the-secret-sauce-behind-better-product-recommendation-mmr-explained/images/naive-retrieval1.png>
<img alt="Naive Top-5 Product Retrieval #2" loading=lazy src=/posts/the-secret-sauce-behind-better-product-recommendation-mmr-explained/images/naive-retrieval2.png></p><p>At a glance, everything seems fine.</p><p>But if we take a closer look, among 5 retrieved products, 3-4 out of 5 are having exactly same type just different colors.</p><p>Even we tried different queries, most of the time the retrieval system will pick very close product to each other.</p><p>Unfortunately, this case didn&rsquo;t pass User Acceptance Test (UAT) due to lack of product diversity ‚Äì or in their term <em>&ldquo;system preference&rdquo;</em>.</p><h2 id=maximum-marginal-relevance-mmr>Maximum Marginal Relevance (MMR)<a hidden class=anchor aria-hidden=true href=#maximum-marginal-relevance-mmr>#</a></h2><p>MMR is a post-processing technique that helps to remove redundant documents by penalize its similarity score.</p><p>In our case, we need to <em><strong>retrieve relevant products which also diverse each other</strong></em>, which is where MMR is suited.</p><p>Here&rsquo;s the MMR formula:</p><p>$$
[ \text{MMR}(d_i) = \lambda \cdot \text{Relevance}(d_i, q) - (1 - \lambda) \cdot \max_{d_j \in S} \text{Similarity}(d_i, d_j) ]
$$</p><p>Where:</p><p>$\lambda:$ Balancing parameter. To controls the trade-off (relevance ‚Äì diverse)</p><p>$\text{Relevance}:$ The relevance score of retrieved document $d_i$ w.r.t query $q$</p><p>$\max_{d_j \in S} \text{Similarity}(d_i, d_j): $ maximum similarity between the candidate document $d_i$ and any of the already selected documents $d_j$ in set $S$</p><h3 id=why-is-this-work>Why is this work?<a hidden class=anchor aria-hidden=true href=#why-is-this-work>#</a></h3><p>Remember that the way RAG and Vector DB work is by comparing similarity between document and query embeddings.</p><p>In most setting, cosine similarity will be used as scoring method ‚Äì which will return the most similar documents to our query.</p><p><img alt="Naive Retrieval Embedding Visualization" loading=lazy src=/posts/the-secret-sauce-behind-better-product-recommendation-mmr-explained/images/naive-retrieval-embedding.png></p><p>In the example above, among the top-5 products 3 of them is very close to the query points. This will introduces the <em>&ldquo;system preference&rdquo;</em> as we define earlier.</p><h3 id=how-mmr-helps>How MMR helps?<a hidden class=anchor aria-hidden=true href=#how-mmr-helps>#</a></h3><p>Remember that we have $\lambda$ parameter that is responsible to control the trade-off between relevance and diversity.</p><p>The bigger $\lambda$ is, the more similar products will be selected. And the smaller it is, the more diverse products will be.</p><p><img alt="MMR Retrieval Embedding Visualization" loading=lazy src=/posts/the-secret-sauce-behind-better-product-recommendation-mmr-explained/images/mmr-retrieval-embedding.png></p><p>Given the same query, we applied MMR algorithm with $\lambda = 0.3$ (more diverse). The final top-5 products as can be seen are quite far each other in vector spaces.</p><p>And it can be validated by checking the MMR-applied retrieval result below:</p><p><img alt="MMR Top-5 Product Retrieval #1" loading=lazy src=/posts/the-secret-sauce-behind-better-product-recommendation-mmr-explained/images/mmr-retrieval1.png>
<img alt="MMR Top-5 Product Retrieval #2" loading=lazy src=/posts/the-secret-sauce-behind-better-product-recommendation-mmr-explained/images/mmr-retrieval2.png></p><h2 id=integrate-mmr-to-our-rag-system>Integrate MMR to our RAG System<a hidden class=anchor aria-hidden=true href=#integrate-mmr-to-our-rag-system>#</a></h2><p>Since MMR is a post-processing method, our RAG architecture will have an additional step before the products are sent to the LLM.</p><p><img alt="RAG with MMR architecture" loading=lazy src=/posts/the-secret-sauce-behind-better-product-recommendation-mmr-explained/images/rag-product-recom-w-mmr-arch.png></p><blockquote><p>üí° I&rsquo;ve previously ingest the product data which you can find it <a href>here</a>.</p><p>Additionally, if you want to jump directly to the code you can find it <a href>here</a>.</p></blockquote><h3 id=install-dependencies>Install Dependencies<a hidden class=anchor aria-hidden=true href=#install-dependencies>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pip install openai qdrant-client pillow matplotlib scikit-learn numpy
</span></span></code></pre></div><h3 id=imports-and-client-initialization>Imports and Client Initialization<a hidden class=anchor aria-hidden=true href=#imports-and-client-initialization>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>openai</span> <span class=kn>import</span> <span class=n>OpenAI</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>polars</span> <span class=k>as</span> <span class=nn>pl</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>uuid</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>httpx</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>asyncio</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>qdrant_client</span> <span class=kn>import</span> <span class=n>QdrantClient</span><span class=p>,</span> <span class=n>models</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>PIL</span> <span class=kn>import</span> <span class=n>Image</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.manifold</span> <span class=kn>import</span> <span class=n>TSNE</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># CONFIG</span>
</span></span><span class=line><span class=cl><span class=n>OPENAI_API_KEY</span> <span class=o>=</span> <span class=s2>&#34;&lt;OPENAI-API-KEY&gt;&#34;</span>
</span></span><span class=line><span class=cl><span class=n>OPENAI_EMBEDDING_MODEL</span> <span class=o>=</span> <span class=s2>&#34;text-embedding-3-small&#34;</span>
</span></span><span class=line><span class=cl><span class=n>QDRANT_HOST</span> <span class=o>=</span> <span class=s2>&#34;localhost&#34;</span>
</span></span><span class=line><span class=cl><span class=n>QDRANT_PORT</span> <span class=o>=</span> <span class=mi>6333</span>
</span></span><span class=line><span class=cl><span class=n>QDRANT_COLLECTION_NAME</span> <span class=o>=</span> <span class=s2>&#34;adidas_products&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>CHROMADB_HOST</span> <span class=o>=</span> <span class=s2>&#34;localhost&#34;</span>
</span></span><span class=line><span class=cl><span class=n>CHROMADB_PORT</span> <span class=o>=</span> <span class=mi>3456</span>
</span></span><span class=line><span class=cl><span class=n>CHROMADB_COLLECTION_NAME</span> <span class=o>=</span> <span class=s2>&#34;adidas_products&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># INIT</span>
</span></span><span class=line><span class=cl><span class=n>oai_client</span> <span class=o>=</span> <span class=n>OpenAI</span><span class=p>(</span><span class=n>api_key</span><span class=o>=</span><span class=n>OPENAI_API_KEY</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>qdrant_client</span> <span class=o>=</span> <span class=n>QdrantClient</span><span class=p>(</span><span class=n>host</span><span class=o>=</span><span class=n>QDRANT_HOST</span><span class=p>,</span> <span class=n>port</span><span class=o>=</span><span class=n>QDRANT_PORT</span><span class=p>)</span>
</span></span></code></pre></div><h3 id=retrieve-relevant-products>Retrieve Relevant Products<a hidden class=anchor aria-hidden=true href=#retrieve-relevant-products>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python3 data-lang=python3><span class=line><span class=cl><span class=n>query</span> <span class=o>=</span> <span class=s2>&#34;Hey, I need fab shoes!&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>query_embeds</span> <span class=o>=</span> <span class=n>oai_client</span><span class=o>.</span><span class=n>embeddings</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nb>input</span><span class=o>=</span><span class=n>query</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>    <span class=n>model</span><span class=o>=</span><span class=n>OPENAI_EMBEDDING_MODEL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>res</span> <span class=o>=</span> <span class=n>qdrant_client</span><span class=o>.</span><span class=n>query_points</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>collection_name</span><span class=o>=</span><span class=n>QDRANT_COLLECTION_NAME</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>query</span><span class=o>=</span><span class=n>query_embeds</span><span class=o>.</span><span class=n>data</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>embedding</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>with_vectors</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>limit</span><span class=o>=</span><span class=mi>100</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></div><p>First, we fetch top-100 relevant products. Then, we will apply MMR and reduce the result into only 5 products.</p><h3 id=define-mmr-reranking-function>Define MMR Reranking Function<a hidden class=anchor aria-hidden=true href=#define-mmr-reranking-function>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python3 data-lang=python3><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.metrics.pairwise</span> <span class=kn>import</span> <span class=n>cosine_similarity</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>maximal_marginal_relevance</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=n>query_embedding</span><span class=p>:</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>embedding_list</span><span class=p>:</span> <span class=nb>list</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>lambda_mult</span><span class=p>:</span> <span class=nb>float</span> <span class=o>=</span> <span class=mf>0.5</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=n>k</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>4</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=nb>int</span><span class=p>]:</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;Calculate maximal marginal relevance.
</span></span></span><span class=line><span class=cl><span class=s2>    
</span></span></span><span class=line><span class=cl><span class=s2>    Usage example:
</span></span></span><span class=line><span class=cl><span class=s2>    ```python
</span></span></span><span class=line><span class=cl><span class=s2>    mmr_selected = maximal_marginal_relevance(
</span></span></span><span class=line><span class=cl><span class=s2>        query_embedding=np.array(query_embed, dtype=np.float32),
</span></span></span><span class=line><span class=cl><span class=s2>        embedding_list=ret_docs[&#34;embeddings&#34;][0],
</span></span></span><span class=line><span class=cl><span class=s2>        lambda_mult=0.4,
</span></span></span><span class=line><span class=cl><span class=s2>        k=10
</span></span></span><span class=line><span class=cl><span class=s2>    )
</span></span></span><span class=line><span class=cl><span class=s2>
</span></span></span><span class=line><span class=cl><span class=s2>    print(mmr_selected)
</span></span></span><span class=line><span class=cl><span class=s2>    
</span></span></span><span class=line><span class=cl><span class=s2>    # Output
</span></span></span><span class=line><span class=cl><span class=s2>    &gt;&gt;&gt; [0, 9, 6, 12, 1, 17, 7, 2, 5, 19]
</span></span></span><span class=line><span class=cl><span class=s2>    ```
</span></span></span><span class=line><span class=cl><span class=s2>    
</span></span></span><span class=line><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>min</span><span class=p>(</span><span class=n>k</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>embedding_list</span><span class=p>))</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>query_embedding</span><span class=p>,</span> <span class=nb>list</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>query_embedding</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>query_embedding</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>query_embedding</span><span class=o>.</span><span class=n>ndim</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>query_embedding</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>expand_dims</span><span class=p>(</span><span class=n>query_embedding</span><span class=p>,</span> <span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>similarity_to_query</span> <span class=o>=</span> <span class=n>cosine_similarity</span><span class=p>(</span><span class=n>query_embedding</span><span class=p>,</span> <span class=n>embedding_list</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>most_similar</span> <span class=o>=</span> <span class=nb>int</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>argmax</span><span class=p>(</span><span class=n>similarity_to_query</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>idxs</span> <span class=o>=</span> <span class=p>[</span><span class=n>most_similar</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>selected</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=n>embedding_list</span><span class=p>[</span><span class=n>most_similar</span><span class=p>]])</span>
</span></span><span class=line><span class=cl>    <span class=k>while</span> <span class=nb>len</span><span class=p>(</span><span class=n>idxs</span><span class=p>)</span> <span class=o>&lt;</span> <span class=nb>min</span><span class=p>(</span><span class=n>k</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>embedding_list</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>        <span class=n>best_score</span> <span class=o>=</span> <span class=o>-</span><span class=n>np</span><span class=o>.</span><span class=n>inf</span>
</span></span><span class=line><span class=cl>        <span class=n>idx_to_add</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>        <span class=n>similarity_to_selected</span> <span class=o>=</span> <span class=n>cosine_similarity</span><span class=p>(</span><span class=n>embedding_list</span><span class=p>,</span> <span class=n>selected</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>query_score</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>similarity_to_query</span><span class=p>):</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>idxs</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>            <span class=n>redundant_score</span> <span class=o>=</span> <span class=nb>max</span><span class=p>(</span><span class=n>similarity_to_selected</span><span class=p>[</span><span class=n>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>            <span class=n>equation_score</span> <span class=o>=</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=n>lambda_mult</span> <span class=o>*</span> <span class=n>query_score</span> <span class=o>-</span> <span class=p>(</span><span class=mi>1</span> <span class=o>-</span> <span class=n>lambda_mult</span><span class=p>)</span> <span class=o>*</span> <span class=n>redundant_score</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>equation_score</span> <span class=o>&gt;</span> <span class=n>best_score</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>best_score</span> <span class=o>=</span> <span class=n>equation_score</span>
</span></span><span class=line><span class=cl>                <span class=n>idx_to_add</span> <span class=o>=</span> <span class=n>i</span>
</span></span><span class=line><span class=cl>        <span class=n>idxs</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>idx_to_add</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>selected</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>selected</span><span class=p>,</span> <span class=p>[</span><span class=n>embedding_list</span><span class=p>[</span><span class=n>idx_to_add</span><span class=p>]],</span> <span class=n>axis</span><span class=o>=</span><span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>idxs</span>
</span></span></code></pre></div><h3 id=apply-mmr-reranking>Apply MMR Reranking<a hidden class=anchor aria-hidden=true href=#apply-mmr-reranking>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python3 data-lang=python3><span class=line><span class=cl><span class=n>MMR_LAMBDA_MULT</span> <span class=o>=</span> <span class=mf>0.3</span>   <span class=c1># prioritize diversity</span>
</span></span><span class=line><span class=cl><span class=n>MMR_K</span> <span class=o>=</span> <span class=mi>5</span>   <span class=c1># number of results to return</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># collect top-100 embeddings</span>
</span></span><span class=line><span class=cl><span class=n>top_100_embeddings</span> <span class=o>=</span> <span class=p>[</span><span class=n>item</span><span class=o>.</span><span class=n>vector</span> <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>res</span><span class=o>.</span><span class=n>points</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># re-rank using MMR then take top-5 result</span>
</span></span><span class=line><span class=cl><span class=n>top_5_mmr_indices</span> <span class=o>=</span> <span class=n>maximal_marginal_relevance</span><span class=p>(</span><span class=n>emb</span><span class=o>.</span><span class=n>embedding</span><span class=p>,</span> <span class=n>top_100_embeddings</span><span class=p>,</span> <span class=n>MMR_LAMBDA_MULT</span><span class=p>,</span> <span class=n>MMR_K</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>top_5_mmr</span> <span class=o>=</span> <span class=p>[</span><span class=n>res</span><span class=o>.</span><span class=n>points</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>top_5_mmr_indices</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>top_5_mmr_payload</span> <span class=o>=</span> <span class=p>[</span><span class=n>item</span><span class=o>.</span><span class=n>payload</span><span class=p>[</span><span class=s2>&#34;metadata&#34;</span><span class=p>]</span> <span class=k>for</span> <span class=n>item</span> <span class=ow>in</span> <span class=n>top_5_mmr</span><span class=p>]</span>
</span></span></code></pre></div><h3 id=visualize-products>Visualize Products<a hidden class=anchor aria-hidden=true href=#visualize-products>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python3 data-lang=python3><span class=line><span class=cl><span class=k>def</span> <span class=nf>visualize_product_rows</span><span class=p>(</span><span class=n>query</span><span class=p>,</span> <span class=n>payload</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>fig</span><span class=p>,</span> <span class=n>ax</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>subplots</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>payload</span><span class=p>),</span> <span class=n>figsize</span><span class=o>=</span><span class=p>(</span><span class=mi>15</span><span class=p>,</span> <span class=mi>8</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>product</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>payload</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>ax</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>imshow</span><span class=p>(</span><span class=n>Image</span><span class=o>.</span><span class=n>open</span><span class=p>(</span><span class=n>product</span><span class=p>[</span><span class=s2>&#34;productImage&#34;</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>        <span class=n>ax</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>set_title</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;</span><span class=si>{</span><span class=n>product</span><span class=p>[</span><span class=s1>&#39;productName&#39;</span><span class=p>]</span><span class=si>}</span><span class=se>\n</span><span class=si>{</span><span class=n>product</span><span class=p>[</span><span class=s1>&#39;productCategory&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>ax</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>.</span><span class=n>set_axis_off</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>fig</span><span class=o>.</span><span class=n>suptitle</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Query: </span><span class=si>{</span><span class=n>query</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>,</span> <span class=n>fontsize</span><span class=o>=</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>plt</span><span class=o>.</span><span class=n>tight_layout</span><span class=p>(</span><span class=n>rect</span><span class=o>=</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mf>1.35</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>visualize_product_rows</span><span class=p>(</span><span class=n>q</span><span class=p>,</span> <span class=n>top_5_mmr_payload</span><span class=p>)</span>
</span></span></code></pre></div><p>And here is the result of our MMR reranked products.
<img alt="MMR Top-5 Product Retrieval #1" loading=lazy src=/posts/the-secret-sauce-behind-better-product-recommendation-mmr-explained/images/mmr-retrieval1.png></p><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>By incorporating Maximal Marginal Relevance (MMR) into our RAG-based product recommendation system, we were able to tune the diversity of retrieved products, eliminating so-called <em>&ldquo;system preference&rdquo;</em> from end user perspective. Ultimately, MMR enable our system to retrieve relevant <strong>and</strong> diverse products.</p><h3 id=key-takeaways>Key Takeaways<a hidden class=anchor aria-hidden=true href=#key-takeaways>#</a></h3><ul><li><strong>MMR Algorithm</strong>, helps to remove redundant recommendations by evaluating relevance and maximizing diversity among selected products.</li><li><strong>Parameter Tuning</strong>, adjust the $\lambda$ parameter allows for fine control over the trade-off between relevance and diversity, enabling a tailored user experience.</li><li><strong>Diversity Enhances Satisfaction</strong>, though may be different for some users, in our case, a varied selection of products leads to a better user experience and higher engagement rates.</li></ul><hr><h3 id=lets-get-connected->Let‚Äôs get Connected üôå<a hidden class=anchor aria-hidden=true href=#lets-get-connected->#</a></h3><p>If you have any inquiries, comments, suggestions, or critics please don‚Äôt hesitate to reach me out:</p><ul><li>Mail: <a href=mailto:affahrizain@gmail.com>affahrizain@gmail.com</a></li><li>LinkedIn: <a href=https://www.linkedin.com/in/fahrizainn/>https://www.linkedin.com/in/fahrizainn/</a></li><li>GitHub: <a href=https://github.com/fhrzn>https://github.com/fhrzn</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://fhrzn.github.io/tags/reranking/>Reranking</a></li><li><a href=https://fhrzn.github.io/tags/rag/>RAG</a></li><li><a href=https://fhrzn.github.io/tags/product-recommendation/>Product Recommendation</a></li><li><a href=https://fhrzn.github.io/tags/recsys/>Recsys</a></li></ul><nav class=paginav><a class=next href=https://fhrzn.github.io/posts/llm-document-parsing-tips/><span class=title>Next ¬ª</span><br><span>Enhance Your LLM‚Äôs Understanding: Document Parsing Tips You Need to Know</span></a></nav><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share The Secret Sauce Behind Better Product Recommendation: MMR Explained on x" href="https://x.com/intent/tweet/?text=The%20Secret%20Sauce%20Behind%20Better%20Product%20Recommendation%3a%20MMR%20Explained&amp;url=https%3a%2f%2ffhrzn.github.io%2fposts%2fthe-secret-sauce-behind-better-product-recommendation-mmr-explained%2f&amp;hashtags=reranking%2cRAG%2cproductrecommendation%2crecsys"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share The Secret Sauce Behind Better Product Recommendation: MMR Explained on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2ffhrzn.github.io%2fposts%2fthe-secret-sauce-behind-better-product-recommendation-mmr-explained%2f&amp;title=The%20Secret%20Sauce%20Behind%20Better%20Product%20Recommendation%3a%20MMR%20Explained&amp;summary=The%20Secret%20Sauce%20Behind%20Better%20Product%20Recommendation%3a%20MMR%20Explained&amp;source=https%3a%2f%2ffhrzn.github.io%2fposts%2fthe-secret-sauce-behind-better-product-recommendation-mmr-explained%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share The Secret Sauce Behind Better Product Recommendation: MMR Explained on reddit" href="https://reddit.com/submit?url=https%3a%2f%2ffhrzn.github.io%2fposts%2fthe-secret-sauce-behind-better-product-recommendation-mmr-explained%2f&title=The%20Secret%20Sauce%20Behind%20Better%20Product%20Recommendation%3a%20MMR%20Explained"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share The Secret Sauce Behind Better Product Recommendation: MMR Explained on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2ffhrzn.github.io%2fposts%2fthe-secret-sauce-behind-better-product-recommendation-mmr-explained%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share The Secret Sauce Behind Better Product Recommendation: MMR Explained on whatsapp" href="https://api.whatsapp.com/send?text=The%20Secret%20Sauce%20Behind%20Better%20Product%20Recommendation%3a%20MMR%20Explained%20-%20https%3a%2f%2ffhrzn.github.io%2fposts%2fthe-secret-sauce-behind-better-product-recommendation-mmr-explained%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share The Secret Sauce Behind Better Product Recommendation: MMR Explained on telegram" href="https://telegram.me/share/url?text=The%20Secret%20Sauce%20Behind%20Better%20Product%20Recommendation%3a%20MMR%20Explained&amp;url=https%3a%2f%2ffhrzn.github.io%2fposts%2fthe-secret-sauce-behind-better-product-recommendation-mmr-explained%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share The Secret Sauce Behind Better Product Recommendation: MMR Explained on ycombinator" href="https://news.ycombinator.com/submitlink?t=The%20Secret%20Sauce%20Behind%20Better%20Product%20Recommendation%3a%20MMR%20Explained&u=https%3a%2f%2ffhrzn.github.io%2fposts%2fthe-secret-sauce-behind-better-product-recommendation-mmr-explained%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer><script src=https://giscus.app/client.js data-repo=fhrzn/fhrzn.github.io data-repo-id=R_kgDOK-oOOw data-category=Q&A data-category-id=DIC_kwDOK-oOO84CcI9D data-mapping=title data-strict=0 data-reactions-enabled=1 data-emit-metadata=1 data-input-position=top data-theme=preferred_color_scheme data-lang=en data-loading=lazy crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2025 <a href=https://fhrzn.github.io/>fahrizain</a></span> ¬∑
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>